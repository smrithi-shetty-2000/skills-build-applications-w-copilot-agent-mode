name: PR Doc Generator

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-doc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR diff
        run: |
          git fetch origin main
          git diff origin/main > pr_changes.txt

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Call Azure OpenAI
        run: |
          # Limit PR content to avoid extremely large payloads
          head -c 20000 pr_changes.txt > pr_trimmed.txt

          # Create request JSON file
          cat <<EOF > request.json
          {
          "messages": [
          {
          "role": "system",
          "content": "You are a professional technical documentation assistant."
          },
          {
          "role": "user",
          "content": "Generate professional Markdown documentation for the following pull request changes.\n\n$(sed 's/"/\\"/g' pr_trimmed.txt)"
          }
          ],
          "max_tokens": 1000
          }
          EOF

          # Call Azure OpenAI using file instead of inline data
          curl -s -X POST "${{ secrets.AZURE_OPENAI_ENDPOINT }}/openai/deployments/${{ secrets.AZURE_OPENAI_DEPLOYMENT }}/chat/completions?api-version=2024-12-01-preview" \
          -H "Content-Type: application/json" \
          -H "api-key: ${{ secrets.AZURE_OPENAI_KEY }}" \
          -d @request.json \
          | jq -r '.choices[0].message.content' > documentation.md

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-documentation
          path: documentation.md
