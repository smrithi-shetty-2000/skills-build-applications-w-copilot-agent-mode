name: Generate PR Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  generate-doc:
    runs-on: ubuntu-latest

    steps:
      # 1️ Checkout full repo history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️ Generate diff using PR base and head
      - name: Generate PR diff
        run: |
          echo "Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head branch: ${{ github.event.pull_request.head.ref }}"

          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr.diff

          # Trim to avoid token overflow
          head -c 15000 pr.diff > pr_trimmed.diff

          echo "Diff size:"
          wc -c pr_trimmed.diff

      # 3️ Install dependencies
      - name: Install jq and pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc

      # 4️ Prepare JSON safely using jq
      - name: Prepare OpenAI request
        run: |
          DIFF_CONTENT=$(cat pr_trimmed.diff)

          jq -n \
          --arg diff "$DIFF_CONTENT" \
          '{
            messages: [
              {
                role: "system",
                content: "You are a senior software documentation assistant."
              },
              {
                role: "user",
                content: ("Analyze this PR diff and generate structured documentation.\n\nInclude:\n- Modified Files\n- Added Files\n- Deleted Files\n- Summary of Changes\n- Entities (classes, functions, APIs modified)\n\nPR Diff:\n" + $diff)
              }
            ],
            temperature: 0.2,
            max_tokens: 1500
          }' > request.json

          cat request.json

      # 5️ Call Azure OpenAI (Updated API version)
      - name: Call Azure OpenAI
        run: |
          curl -s -X POST \
          "${{ secrets.AZURE_OPENAI_ENDPOINT }}/openai/deployments/o3-mini/chat/completions?api-version=2024-12-01-preview" \
          -H "Content-Type: application/json" \
          -H "api-key: ${{ secrets.AZURE_OPENAI_KEY }}" \
          -d @request.json \
          -o response.json

          echo "Response:"
          cat response.json

      # 6️ Extract documentation safely
      - name: Extract documentation
        run: |
          if jq -e '.choices[0].message.content' response.json > /dev/null; then
            jq -r '.choices[0].message.content' response.json > documentation.md
          else
            echo "Azure OpenAI returned an error:" > documentation.md
            jq -r '.error.message' response.json >> documentation.md
          fi

          echo "Generated documentation:"
          cat documentation.md

      # 7️ Convert to Word document
      - name: Convert to Word document
        run: |
          pandoc documentation.md -o PR_Documentation.docx

      # 8️ Upload artifact
      - name: Upload PR Documentation
        uses: actions/upload-artifact@v4
        with:
          name: PR-Documentation
          path: PR_Documentation.docx
